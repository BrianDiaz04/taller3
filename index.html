<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Prueba Shader Chroma Key</title>

    <!-- 1️⃣ Primero cargamos A-Frame -->
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe.min.js"></script>

    <!-- 2️⃣ Luego registramos el shader -->
    <script>
      AFRAME.registerShader('chroma-key', {
        schema: {
          src: {type: 'map'},
          color: {type: 'color', default: 'green'},
          similarity: {type: 'number', default: 0.3},
          smoothness: {type: 'number', default: 0.1}
        },
        vertexShader: `
          varying vec2 vUV;
          void main(void) {
            vUV = uv;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
          }
        `,
        fragmentShader: `
          uniform sampler2D src;
          uniform vec3 color;
          uniform float similarity;
          uniform float smoothness;
          varying vec2 vUV;

          void main(void) {
            vec4 videoColor = texture2D(src, vUV);

            float Y  = 0.2989*videoColor.r + 0.5866*videoColor.g + 0.1145*videoColor.b;
            float Cr = videoColor.r - Y;
            float Cb = videoColor.b - Y;

            float targetY  = 0.2989*color.r + 0.5866*color.g + 0.1145*color.b;
            float targetCr = color.r - targetY;
            float targetCb = color.b - targetY;

            float diff = distance(vec2(Cr, Cb), vec2(targetCr, targetCb));
            float blend = smoothstep(similarity, similarity + smoothness, diff);

            gl_FragColor = vec4(videoColor.rgb, videoColor.a * blend);
          }
        `
      });
    </script>

    <style>
      html, body { margin: 0; height: 100%; overflow: hidden; background: #0033cc; }
      a-scene { width: 100%; height: 100%; }
    </style>
  </head>

  <body>
    <a-scene embedded>
      <a-assets>
        <video id="miVideo" src="./video.mp4" autoplay loop playsinline muted></video>
      </a-assets>

      <a-entity camera position="0 0 3"></a-entity>

      <a-plane
        position="0 0 0"
        width="3"
        height="2"
        material="shader: chroma-key; src: #miVideo; color: green; similarity: 0.3; smoothness: 0.1;"
      ></a-plane>
    </a-scene>

    <script>
      const video = document.querySelector('#miVideo');
      document.body.addEventListener('click', () => {
        if (video.paused) video.play();
      });
    </script>
  </body>
</html>

