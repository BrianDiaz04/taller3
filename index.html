<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>AR Video Chroma Key - GitHub Pages</title>

  <!-- Librerías: primero A-Frame, luego MindAR -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: black; }
    #ar-container { width: 100%; height: 100vh; touch-action: none; }
    a-scene { width: 100vw; height: 100vh; }
  </style>
</head>
<body>
  <div id="ar-container">
    <a-scene
      mindar-image="imageTargetSrc: ./mi-sticker.mind;"
      embedded
      color-space="sRGB"
      renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true;"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: true"
    >
      <!-- Assets -->
      <a-assets>
        <video id="miVideo" src="./video.mp4" autoplay loop playsinline crossorigin="anonymous"></video>
      </a-assets>

      <!-- Cámara AR -->
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Video sobre marcador -->
      <a-entity mindar-image-target="targetIndex: 0">
        <a-plane id="videoPlane"
                 position="0 0 0"
                 height="2.5"
                 width="1.5"
                 material="shader: chroma-key; src: #miVideo; colorToReplace: 0 1 0; threshold: 0.4; transparent: true;">
        </a-plane>
      </a-entity>
    </a-scene>
  </div>

  <!-- Shader y play del video al toque -->
  <script>
    // Registrar shader **después** de que A-Frame ya esté cargado
    AFRAME.registerShader('chroma-key', {
      schema: {
        src: {type: 'map'},
        colorToReplace: {type: 'vec3', default: {x: 0, y: 1, z: 0}}, // Verde puro
        threshold: {type: 'number', default: 0.4}
      },
      vertexShader: `
        varying vec2 vUV;
        void main() {
          vUV = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,
      fragmentShader: `
        uniform sampler2D src;
        uniform vec3 colorToReplace;
        uniform float threshold;
        varying vec2 vUV;
        void main() {
          vec4 color = texture2D(src, vUV);
          float diff = distance(color.rgb, colorToReplace);
          if (diff < threshold) discard;
          gl_FragColor = vec4(color.rgb, color.a);
        }
      `
    });

    // Forzar play del video y arranque de MindAR en móviles
    const video = document.querySelector('#miVideo');
    const sceneEl = document.querySelector('a-scene');

    document.body.addEventListener('click', async () => {
      if (video.paused) await video.play();

      // Iniciar MindAR
      if (sceneEl.systems["mindar-image-system"]) {
        sceneEl.systems["mindar-image-system"].start();
      }
    });
  </script>
</body>
</html>

